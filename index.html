<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rocket Simulator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {font-family: sans-serif; margin: 20px;}
  #controls {margin-bottom: 20px;}
  .control-group {margin-bottom: 15px; padding-right: 20px;}
  .control-group label {display: block; font-weight: bold;}
  .input-pair input[type="number"] {width: 60px; margin-right: 10px; text-align: right;}
  .input-pair input[type="range"] {width: 150px;}

  #rocketCanvas {
    background: #e0f7fa;
    border: 1px solid #ccc;
    margin-bottom: 20px; 
    display: block; 
  }
</style>
</head>
<body>

<h2>Rocket Simulator</h2>

<canvas id="rocketCanvas" width="800" height="150"></canvas> 

<div id="controls">
    
    <div class="control-group">
        <label>Initial Mass (kg): <span id="m0Value">1000</span></label>
        <div class="input-pair">
            <input type="number" id="m0Input" min="500" max="2000" step="10" value="1000">
            <input type="range" id="m0Slider" min="500" max="2000" value="1000">
        </div>
    </div>

    <div class="control-group">
        <label>Fuel Mass (kg): <span id="fuelValue">500</span></label>
        <div class="input-pair">
            <input type="number" id="fuelInput" min="0" max="900" step="10" value="500">
            <input type="range" id="fuelSlider" min="0" max="900" value="500">
        </div>
    </div>

    <div class="control-group">
        <label>Exhaust Velocity (m/s): <span id="veValue">3000</span></label>
        <div class="input-pair">
            <input type="number" id="veInput" min="1000" max="5000" step="100" value="3000">
            <input type="range" id="veSlider" min="1000" max="5000" value="3000">
        </div>
    </div>

    <div class="control-group">
        <label>Mass Flow Rate (kg/s): <span id="betaValue">5</span></label>
        <div class="input-pair">
            <input type="number" id="betaInput" min="1" max="20" step="0.1" value="5">
            <input type="range" id="betaSlider" min="1" max="20" value="5">
        </div>
    </div>
</div>

<p>Predicted Final Velocity: <span id="finalV">0</span> m/s</p>
<p>Burn Time: <span id="burnTime">0</span>s</p>

<canvas id="velocityChart" width="600" height="300"></canvas>
<canvas id="thrustChart" width="600" height="300"></canvas>


<script>
let m0 = 1000; // kg 
let fuelMass = 500; // kg 
let ve = 3000; // m/s
let beta = 5; // kg/s
const dt = 0.1; // time step
const tMax = 500; // maximum simulation time in seconds 

const velocityCtx = document.getElementById('velocityChart').getContext('2d');
const thrustCtx = document.getElementById('thrustChart').getContext('2d');
const rocketCtx = document.getElementById('rocketCanvas').getContext('2d');

let rocketX = 50; 
let currentRocketVelocity = 0; 
let animationFrameId; 

// Particle system variables
const particles = [];
const maxParticles = 200; 
const particleLife = 60; 
const particleSize = 3; 

// Initialize Charts
let velocityChart = new Chart(velocityCtx, {
  type: 'line',
  data: {labels: [], datasets:[{label:'Velocity (m/s)', data:[], borderColor:'blue', fill:false}]},
  options: {
    responsive:true,
    scales:{
      x:{
          title:{display:true,text:'Time (s)'},
          ticks: {
              // FIX: Re-enable callback to force integers (no decimals)
              callback: function(value, index, values) {
                  return Number(value/10).toFixed(0); 
              }
          }
      }, 
      y:{title:{display:true,text:'Velocity (m/s)'}}
    }
  }
});

let thrustChart = new Chart(thrustCtx, {
  type: 'line',
  data: {labels: [], datasets:[{label:'Thrust (N)', data:[], borderColor:'red', fill:false}]},
  options: {
    responsive:true,
    scales:{
      x:{
          title:{display:true,text:'Time (s)'},
          ticks: {
              // FIX: Re-enable callback to force integers (no decimals)
              callback: function(value, index, values) {
                  return Number(value/10).toFixed(0); 
              }
          }
      }, 
      y:{title:{display:true,text:'Thrust (N)'}}
    }
  }
});

// --- ROCKET SIMULATION WITH CUTOFF LOGIC ---
function simulateRocket() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId); 
    }

  let mass = m0;
  let velocity = 0;
  let t = 0;
  let timeData = [];
  let velocityData = [];
  let thrustData = [];
    let engine_on = true;

  // 1. Simulation Loop (Engine ON / Coasting)
  while (t <= tMax) {
        let thrust = 0;
        let dv = 0;

        if (engine_on) {
            thrust = beta * ve;
            dv = thrust / mass * dt;
            velocity += dv;
            mass -= beta * dt;
        }

        // Check for Engine Cutoff
        if (engine_on && mass <= m0 - fuelMass) {
            mass = m0 - fuelMass; 
            engine_on = false;
        }
        
        t += dt;

        // FIX: Push the true time (t), not a scaled value (t * 10)
        timeData.push(t); 
        velocityData.push(velocity);
        thrustData.push(thrust);
        
        if (t >= tMax) break;
  }
    
    // Calculate final burn time
    const finalMass = m0 - fuelMass;
    let burnTime = fuelMass / beta;
    
    if (burnTime > tMax) {
        burnTime = tMax;
        document.getElementById('burnTime').textContent = `>${tMax.toFixed(1)} s (Fuel not depleted)`;
    } else {
        document.getElementById('burnTime').textContent = `${burnTime.toFixed(2)} s`;
    }

  document.getElementById('finalV').textContent = velocity.toFixed(2);

  velocityChart.data.labels = timeData;
  velocityChart.data.datasets[0].data = velocityData;
  velocityChart.update();

  thrustChart.data.labels = timeData;
  thrustChart.data.datasets[0].data = thrustData;
  thrustChart.update();

    rocketX = 50; 
    currentRocketVelocity = 0;
    particles.length = 0; 
    animateRocket(velocityData, burnTime); 
}

// Draw a simple rocket (oriented horizontally) - Unchanged
function drawRocket(ctx, x, y) {
    const rocketWidth = 80;  
    const rocketHeight = 40; 
    const noseLength = 20;
    const finWidth = 20;

    ctx.fillStyle = '#90A4AE'; 
    ctx.fillRect(x, y - rocketHeight / 2, rocketWidth, rocketHeight);

    ctx.fillStyle = '#EF5350'; 
    ctx.beginPath();
    ctx.moveTo(x + rocketWidth, y - rocketHeight / 2);
    ctx.lineTo(x + rocketWidth + noseLength, y);
    ctx.lineTo(x + rocketWidth, y + rocketHeight / 2);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = '#66BB6A'; 
    ctx.beginPath();
    ctx.moveTo(x + finWidth, y - rocketHeight / 2); 
    ctx.lineTo(x, y - rocketHeight / 2 - 15);     
    ctx.lineTo(x - 10, y - rocketHeight / 2);     
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(x + finWidth, y + rocketHeight / 2); 
    ctx.lineTo(x, y + rocketHeight / 2 + 15);     
    ctx.lineTo(x - 10, y + rocketHeight / 2);     
    ctx.closePath();
    ctx.fill();
}


// Animate Rocket with Exhaust Particles (horizontal movement) - Unchanged
function animateRocket(velocityData, burnTime, animationTime = 0) {
    const engineOn = animationTime < burnTime;

    if (velocityData.length > 0) {
        const timeIndex = Math.min(Math.floor(animationTime / dt), velocityData.length - 1);
        currentRocketVelocity = velocityData[timeIndex];
    } else {
        currentRocketVelocity = 0;
    }

    rocketCtx.clearRect(0, 0, rocketCtx.canvas.width, rocketCtx.canvas.height);

    rocketX += currentRocketVelocity * 0.005; 
    if (rocketX > rocketCtx.canvas.width - 100) rocketX = rocketCtx.canvas.width - 100; 
    
    const rocketCenterY = rocketCtx.canvas.height / 2;
    const exhaustX = rocketX; 
    const exhaustY = rocketCenterY; 

    // --- Particle System (Only active if engine is ON) ---
    if (engineOn) {
        const particlesToAdd = Math.floor(beta * 0.5); 
        for (let i = 0; i < particlesToAdd && particles.length < maxParticles; i++) {
            const angle = Math.random() * Math.PI / 3 - Math.PI / 6;
            const speed = (ve / 1000) + Math.random() * 2; 
            particles.push({
                x: exhaustX, 
                y: exhaustY + (Math.random() - 0.5) * 5, 
                vx: -Math.cos(angle) * speed, 
                vy: Math.sin(angle) * speed,  
                life: particleLife,
                size: particleSize + Math.random() * 2
            });
        }
    }

    // Update and draw particles
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy; 
        p.life--;

        const opacity = p.life / particleLife;
        rocketCtx.fillStyle = `rgba(255, 165, 0, ${opacity})`; 
        rocketCtx.beginPath();
        rocketCtx.arc(p.x, p.y, p.size * opacity, 0, Math.PI * 2);
        rocketCtx.fill();

        if (p.life <= 0 || p.x < 0) { 
            particles.splice(i, 1); 
        }
    }

    drawRocket(rocketCtx, rocketX, rocketCenterY); 

    if (animationTime < tMax || particles.length > 0) {
        animationFrameId = requestAnimationFrame(() => animateRocket(velocityData, burnTime, animationTime + dt));
    } else {
        animationFrameId = null; 
    }
}

// --- SLIDER SYNCHRONIZATION AND UPDATES ---
function updateFuelMax() {
    const maxFuel = Math.floor(m0 * 0.9);
    const fuelInput = document.getElementById('fuelInput');
    const fuelSlider = document.getElementById('fuelSlider');
    
    fuelInput.max = maxFuel;
    fuelSlider.max = maxFuel;

    if (fuelMass > maxFuel) {
        fuelMass = maxFuel;
        fuelInput.value = maxFuel;
        fuelSlider.value = maxFuel;
    }

    document.getElementById('fuelValue').textContent = fuelMass;
}

function setupInputSynchronization(variableName, inputId, sliderId, labelId) {
    const input = document.getElementById(inputId);
    const slider = document.getElementById(sliderId);
    const label = document.getElementById(labelId);

    function updateValue(newValue) {
        let value = Number(newValue);
        
        const min = Number(input.min);
        const max = Number(input.max);
        if (value < min) value = min;
        if (value > max) value = max;
        
        if (variableName === 'm0') {
            m0 = value;
            updateFuelMax();
        } else if (variableName === 'fuelMass') {
            fuelMass = value;
        } else if (variableName === 've') {
            ve = value;
        } else if (variableName === 'beta') {
            beta = value;
        }

        input.value = value;
        slider.value = value;
        label.textContent = value;
        
        simulateRocket();
    }

    input.addEventListener('input', e => {
        updateValue(e.target.value);
    });
    
    slider.addEventListener('input', e => {
        updateValue(e.target.value);
    });
}

// Setup for all four controls
setupInputSynchronization('m0', 'm0Input', 'm0Slider', 'm0Value');
setupInputSynchronization('fuelMass', 'fuelInput', 'fuelSlider', 'fuelValue');
setupInputSynchronization('ve', 'veInput', 'veSlider', 'veValue');
setupInputSynchronization('beta', 'betaInput', 'betaSlider', 'betaValue');

// Initial setup and simulation
updateFuelMax();
simulateRocket();
</script>

</body>
</html>
